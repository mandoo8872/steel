# QR 스캔 관리 시스템 운영 가이드

## 시스템 개요

QR 스캔 관리 시스템은 스캐너에서 생성된 PDF 파일을 자동으로 처리하여:
1. QR 코드를 인식하고 운송번호를 추출
2. 운송번호별로 파일을 분류 및 병합
3. NAS 또는 HTTP API로 업로드
4. 웹 기반 관리자 UI로 모니터링 및 제어

## 기본 운영

### 시스템 시작/중지

#### Windows 서비스
```bash
# 시작
net start QRScanService

# 중지
net stop QRScanService

# 재시작
net stop QRScanService && net start QRScanService

# 상태 확인
sc query QRScanService
```

#### 개발 모드
```bash
# 시작
python main.py

# 중지: Ctrl+C
```

### 웹 UI 접속

1. 브라우저에서 http://localhost:8000 접속
2. 비밀번호 입력: 1212
3. 대시보드에서 현재 상태 확인

## 일상 운영

### 1. 모니터링

#### 대시보드 확인 항목
- **전체 문서**: 처리된 총 문서 수
- **대기중**: 병합 대기 중인 문서
- **업로드 완료**: 성공적으로 업로드된 문서
- **오류**: 처리 실패한 문서

#### 실시간 모니터링
- 최근 처리 문서 목록
- 처리 큐 상태
- 오류 발생 현황

### 2. 오류 처리

#### 오류 유형별 대응

**QR 인식 실패**
1. 오류 관리 메뉴 접속
2. 해당 파일 선택
3. 운송번호 수동 입력
4. 재처리 버튼 클릭

**다중 QR 검출**
1. 오류 관리에서 파일 확인
2. 올바른 운송번호 선택 또는 입력
3. 재처리

**업로드 실패**
- 자동 재시도 진행 (설정된 횟수만큼)
- 최대 재시도 초과 시 error 폴더로 이동
- 네트워크 상태 확인 후 수동 재처리

### 3. 배치 처리

#### 자동 배치
- 유휴 시간 모드: 설정된 시간(기본 5분) 동안 활동 없을 때
- 스케줄 모드: 설정된 시간마다 정기 실행

#### 수동 배치
1. 대시보드 또는 사이드바에서 "지금 배치 실행" 클릭
2. 확인 메시지에서 "확인"

## 설정 관리

### 주요 설정 항목

#### 시스템 설정
- **로그 레벨**: DEBUG, INFO, WARNING, ERROR
- **워커 수**: 동시 처리 작업 수 (2-4 권장)

#### 경로 설정
- **스캐너 출력 폴더**: 스캐너가 PDF를 저장하는 위치
- **데이터 저장 폴더**: 시스템이 파일을 관리하는 위치

#### QR 설정
- **QR 패턴**: 정규식 (기본: 14자리 숫자)
- **다중 QR 처리**: manual(수동 선택) 또는 error(에러 처리)

#### 업로드 설정
- **타입**: NAS, HTTP, 또는 Both
- **NAS 경로**: 네트워크 드라이브 경로
- **HTTP 엔드포인트**: API URL

### 설정 변경 절차
1. 웹 UI에서 설정 메뉴 접속
2. 필요한 항목 수정
3. "설정 저장" 버튼 클릭
4. 일부 설정은 서비스 재시작 필요

## 폴더 구조

```
data/
├── pending/      # 처리 대기 파일
│   └── YYYYMMDD/ # 날짜별 분류
├── merged/       # 병합 완료 파일
│   └── YYYYMMDD/
├── uploaded/     # 업로드 완료 파일
│   └── YYYYMMDD/
├── error/        # 오류 파일
│   └── YYYYMMDD/
└── logs/         # 시스템 로그
```

## 파일 처리 흐름

1. **스캔**: 스캐너 → scanner_output 폴더
2. **QR 인식**: 운송번호 추출
3. **분류**: pending/YYYYMMDD 폴더로 이동
4. **병합**: 동일 운송번호 파일 병합 → merged 폴더
5. **업로드**: NAS/HTTP 전송 → uploaded 폴더
6. **보관**: 설정된 기간 동안 보관 후 자동 삭제

## 로그 확인

### 웹 UI에서 확인
1. 처리 로그 메뉴 접속
2. 작업별, 상태별 필터링
3. 상세 정보 확인

### 파일 로그 확인
```
data/logs/qr_system_YYYY-MM-DD.log
```

## 백업 및 복구

### 백업 대상
1. **설정 파일**: config.yaml
2. **데이터베이스**: data/qr_system.db
3. **처리된 파일**: uploaded 폴더 (선택적)

### 백업 절차
```bash
# 서비스 중지
net stop QRScanService

# 백업 생성
xcopy config.yaml backup\
xcopy data\qr_system.db backup\
xcopy data\uploaded backup\uploaded\ /E

# 서비스 시작
net start QRScanService
```

### 복구 절차
1. 서비스 중지
2. 백업 파일 복원
3. 서비스 시작
4. 웹 UI에서 상태 확인

## 문제 해결

### 서비스가 시작되지 않음
1. Windows 이벤트 뷰어 확인
2. 로그 파일 확인
3. 설정 파일 검증
4. Python 및 의존성 확인

### PDF 처리가 안 됨
1. 스캐너 출력 폴더 경로 확인
2. 파일 권한 확인
3. PDF 파일 무결성 확인
4. Poppler 설치 상태 확인

### 업로드 실패
1. 네트워크 연결 확인
2. NAS 경로 접근 권한 확인
3. API 엔드포인트 응답 확인
4. 파일 크기 제한 확인

### 메모리 사용량 높음
1. 워커 수 감소
2. 배치 크기 조정
3. 로그 레벨 조정 (DEBUG → INFO)
4. 오래된 로그 파일 정리

## 성능 최적화

### 권장 설정
- 워커 수: CPU 코어 수의 50-75%
- 유휴 시간: 5-10분
- 파일 안정성 대기: 3초
- 로그 레벨: INFO (운영 환경)

### 대용량 처리
- 배치 모드를 스케줄로 변경
- 중복 제거 옵션 활성화
- PDF 정규화 비활성화 (속도 우선)

## 보안 고려사항

1. **접근 제어**
   - 관리자 비밀번호 변경 (기본: 1212)
   - 방화벽에서 필요한 포트만 허용

2. **데이터 보호**
   - 민감한 설정은 암호화 저장
   - 정기적인 백업

3. **감사**
   - 모든 작업이 로그에 기록
   - 처리 이력 추적 가능
